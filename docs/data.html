<!doctype html>
<html class="no-js" lang="en">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />
<link rel="index" title="Index" href="genindex.html" /><link rel="search" title="Search" href="search.html" />
        <link rel="canonical" href="/near_recommender/data.html" />

    <!-- Generated with Sphinx 6.2.1 and Furo 2023.03.27 -->
        <title>Data - near-recommender 0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo.css?digest=fad236701ea90a88636c2a8c73b44ae642ed2a53" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo-extensions.css?digest=30d1aed668e5c3a91c3e3bf6a60b675221979f0e" />
    
    


<style>
  body {
    --color-code-background: #eeffcc;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="index.html"><div class="brand">near-recommender 0.1 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="index.html">
  
  
  <span class="sidebar-brand-text">near-recommender 0.1 documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul>
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="introduction.html#commands">Commands</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="source/near_recommender.src.features.html">near_recommender.src.features package</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="introduction.html#models">Models</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="source/near_recommender.src.models.html">near_recommender.src.models package</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="introduction.html#data">Data</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="source/near_recommender.src.data.html">near_recommender.src.data package</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="source/near_recommender.src.data.queries.html">near_recommender.src.data.queries package</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="source/near_recommender.html">near_recommender package</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3 has-children"><a class="reference internal" href="source/near_recommender.src.html">near_recommender package</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" role="switch" type="checkbox"/><label for="toctree-checkbox-6"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4 has-children"><a class="reference internal" href="source/near_recommender.src.data.html">near_recommender.src.data package</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" role="switch" type="checkbox"/><label for="toctree-checkbox-7"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l5"><a class="reference internal" href="source/near_recommender.src.data.queries.html">near_recommender.src.data.queries package</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="source/near_recommender.src.features.html">near_recommender.src.features package</a></li>
<li class="toctree-l4"><a class="reference internal" href="source/near_recommender.src.models.html">near_recommender.src.models package</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <section id="data">
<h1>Data<a class="headerlink" href="#data" title="Permalink to this heading">#</a></h1>
<p>This section provides details about the queries used to feed the models.</p>
<section id="sql-queries">
<h2>SQL queries<a class="headerlink" href="#sql-queries" title="Permalink to this heading">#</a></h2>
<section id="remove-duplicates-query">
<h3>Remove duplicates query<a class="headerlink" href="#remove-duplicates-query" title="Permalink to this heading">#</a></h3>
<p>This query is used to remove duplicates from <code class="docutils literal notranslate"><span class="pre">hive_metastore.mainnet.silver_near_social_txs_parsed</span></code> table.</p>
<p>The query utilizes two Common Table Expressions (CTEs) to handle transactions. All transactions are aggregated, with a new column <code class="docutils literal notranslate"><span class="pre">tx_count</span></code> counting the number of times each transaction appears. Then, using this column, transactions are filtered:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">duplicates</span></code> This CTE captures all transactions that are duplicated (<code class="docutils literal notranslate"><span class="pre">tx_count</span> <span class="pre">&gt;</span> <span class="pre">1</span></code>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">unique_txs</span></code> This CTE contains only the unique transactions (<code class="docutils literal notranslate"><span class="pre">tx_count</span> <span class="pre">=</span> <span class="pre">1</span></code>).</p></li>
</ul>
<p>By merging these two CTEs, we create a new table without any duplicates. The resulting table is saved as <code class="docutils literal notranslate"><span class="pre">hive_metastore.sit.near_social_txs_clean</span></code>.</p>
</section>
<section id="graph-table-query">
<h3>Graph table query<a class="headerlink" href="#graph-table-query" title="Permalink to this heading">#</a></h3>
<p>This query is used to create an edge table that represents the social network in a graph format.</p>
<p>Each row of this table represents a follow transaction with:</p>
<ul class="simple">
<li><p>signer_id</p></li>
<li><p>user followed</p></li>
<li><p>type (FOLLOW or UNFOLLOW)</p></li>
<li><p>date</p></li>
</ul>
<p>First step is to parse the <code class="docutils literal notranslate"><span class="pre">graph:follow</span></code> argument from the <code class="docutils literal notranslate"><span class="pre">hive_metastore.mainnet.silver_near_social_txs_parsed</span></code> table and filter non-null, non-empty and non-failed transactions as represented by the <code class="docutils literal notranslate"><span class="pre">WHERE</span></code> clause on the first CTE.</p>
<p>Then, two different CTEs extract the followed user name on two different scenarios:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">single_user_follows</span></code> extracts the substring that contains the user name. In this case, each transaction represents following one single user</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">batch_user_follows</span></code> uses the same logic to extract the user name but uses first an explode to deal with multiple follows in a single transaction. This was enabled by a batch following widget.</p></li>
</ul>
<p>By merging the two CTEs above, we obtain a table with the edges of the graph representing the following connections in the social network. This table is saved as <code class="docutils literal notranslate"><span class="pre">hive_metastore.sit.graph_follows</span></code>.</p>
</section>
<section id="user-metrics-query">
<h3>User metrics query<a class="headerlink" href="#user-metrics-query" title="Permalink to this heading">#</a></h3>
<p>Query to create a table with different user metrics and calculate trending metric from them.</p>
<p>Metrics can be divided into 3 categories:</p>
<ul>
<li><p>Metrics directly aggregated from the <code class="docutils literal notranslate"><span class="pre">hive_metastore.sit.near_social_txs_clean</span></code> table. These include 10 all-time metrics and 4 metrics for the past 30 days. All of them are calculated in the CTEs <code class="docutils literal notranslate"><span class="pre">metrics_raw</span></code> and <code class="docutils literal notranslate"><span class="pre">last_month_activity</span></code>.</p></li>
<li><p>Metrics that need additional CTES for their calculation:</p>
<blockquote>
<div><ul class="simple">
<li><p>Likes are calculated parsing the <code class="docutils literal notranslate"><span class="pre">index:like</span></code> argument from the <code class="docutils literal notranslate"><span class="pre">hive_metastore.mainnet.silver_near_social_txs_parsed</span></code> table and agreggating for the signer:id and the likee separately. Additionally, both metrics are calculated for the past 30 days.</p></li>
<li><p>Follows are calculated following the same structure as for the graph table query (see section above). When calculating the total followers and following for each user, separate methods have been used, empirically testing them with data from the social network. There is some slight mismatch which is thought to be caused by some missing transactions, but the final result is accurate enough (Max. 3% error on one user from the top 10 most followed accounts).</p></li>
<li><p>Comments for the past 30 days are calculated parsing the <code class="docutils literal notranslate"><span class="pre">post:comment:item</span></code> argument from the <code class="docutils literal notranslate"><span class="pre">hive_metastore.mainnet.silver_near_social_txs_parsed</span></code> table.</p></li>
</ul>
</div></blockquote>
</li>
<li><p>Engagement, activity and trending metrics. These are calculated based on the previous categories, with the following definitions:</p>
<blockquote>
<div><ul class="simple">
<li><p>Engagement is calculated as the sum of comments, likers and followers in the past 30 days. There is a weighted variant using 1, 0.5 and 0.1 weights respectively.</p></li>
<li><p>Activity is calculated as the sum of posts, likes and followings in the past 30 days. There is a weighted variant using 1, 0.5 and 0.1 weights respectively.</p></li>
<li><p>The trending metric is defined as the ratio between weighted engagement and weighted activity with the intention of selecting the users which create the most appealing content for the network.</p></li>
</ul>
</div></blockquote>
</li>
</ul>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference internal" href="source/near_recommender.src.data.html">near_recommender.src.data package</a></li>
</ul>
</div>
</section>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Data</a><ul>
<li><a class="reference internal" href="#sql-queries">SQL queries</a><ul>
<li><a class="reference internal" href="#remove-duplicates-query">Remove duplicates query</a></li>
<li><a class="reference internal" href="#graph-table-query">Graph table query</a></li>
<li><a class="reference internal" href="#user-metrics-query">User metrics query</a></li>
</ul>
</li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/sphinx_highlight.js"></script>
    <script src="_static/scripts/furo.js"></script>
    </body>
</html>